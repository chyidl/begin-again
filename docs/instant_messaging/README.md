# Instant Messaging, IM 即时消息


## IM应用场景&业务功能
* QQ/Wechat 聊天类场景: 即时通讯
* 豆瓣/知乎 社区类场景: 用户点对点聊天
* YY/抖音 直播类场景: 主播互动、实时弹幕
* 小米/京东智能家居类IOT场景: 实时监控、远程控制
* 畅游游戏类场景: 多人互动
* 滴滴/Uber交通类场景: 位置共享
* 新东方/网易云课堂 教学类场景: 在线白板

## IM 架构体系
> IM 架构设计在大规模分布式、高并发、一致性架构设计等方面有很多成熟的解决方案。涵盖了网络、数据库、性能、安全、分布式、架构设计、消息队列


## 聊天系统
```
# 普通视角
    用户账号: 唯一标识
    账号关系: 关系链
    联系人列表:
    消息:
    聊天会话:

# 开发视角
    客户端:
    接入服务:
        连接保持,
        协议解析，
        Session维护: session的作用是标识“那个用户在那个TCP连接”用于后续的消息推送能够知道如何找到接入人对应的连接来发送
        消息推送: 通过网络连接把最终的消息从服务器传输送达用户的设备上
    业务处理服务:
        存储处理、
        消息同步、
        离线buffer、
        未阅读数
        更新最近联系人
    存储服务:
        消息:
        账号信息:
        设置:
        附件:
    外部接口服务:
        通过公共连接服务进行操作系统级"消息推送"
        APNs (Apple Push Notification service) 苹果手机自带的APNs服务
        GCM (Google Cloud Messaging) 安卓手机内置服务

接入服务和业务处理拆分：
    1. 接入服务作为消息首发的出入口，必须是一个高可用的服务，保持足够的稳定性
    2. 接入服务和业务处理服务进行拆分有助于提升业务开发效率，降低业务开发门槛

1. 实时性 保证消息实时触达是互动场景的必备能力
2. 可靠性 [不丢消息、消息不重复]
3. 一致性 多用户、多终端的一致性体验能大幅提升IM系统的使用体验
4. 安全性 [数据传输安全、数据存储安全、数据内容安全]

# 对原有业务系统增加实时消息模块
1. 消息存储:
    对消息进行服务端存储
2. 消息索引和消息内容:
    库表设计上分析
        1. 索引表中收发双方各自有自己的索引记录, 一条是消息发送方的发件箱索引表[user_id, 内容表ID]，另一条是消息接收方的收件箱索引表[], 消息内容表[消息ID，消息内容，消息类型，消息产生时间]
3. 联系人列表:
    联系人列表只更新存储收发双方的最新一条消息，不存储两人所有的历史消息
    消息索引表的使用场景一般用于查询收发双方的历史聊天记录，是聊天会话纬度，联系人表的使用场景用于查询某一个人最近的所有联系人，是用户全局纬度
```

#内容表
> 存储消息纬度的一些基本信息,
| 消息ID | 消息内容 | 消息类型 | 消息产生时间 |
|:-------|:---------|:---------|:-------------|
| 1001   | 你好     | 文本消息 | 2020-07-15 12:00:00|

#索引表
> 收发双方各自有一条自己的索引记录
| 索引用户UID | 索引消息另一方UID | 是发件箱还是收件箱 | 消息ID |
|:------------|:------------------|:-------------------|:-------|
| 张三UID     | 李四UID           | 0                  | 1001   |
| 李四UID     | 张三UID           | 1                  | 1001   |

#联系人表
| 索引用户UID | 索引消息的另一方UID | 消息ID |
|:------------|:--------------------|:-------|
| 张三UID     | 李四UID             | 1001   |
| 李四UID     | 张三UID             | 1001   |

# 消息收发通道
* 消息发送通道
    > 发送方通过发送通道把消息从本地发送到IM服务端
    ```
    1. IM服务端提供HTTP协议API接口，客户端需要发送消息，调用这个接口把消息发给IM服务端
    2. 客户端和IM服务端维护一个TCP长连接，客户端有消息发送时，会以私有协议封装这条要发送的消息，然后通过TCP长连接把消息发给IM服务端
    ```

* 消息接受通道
    > IM服务端通过通道把消息投递给接收方
    ```

    ```

## FAQ
* 1. 消息一定需要在服务端的存储服务存储吗？
